= Inugami Project analysis maven plugin
:toc:
:source-highlighter: pygments

== Last Release:
[source,xml]
----
<dependency>
    <groupId>io.inugami.maven.plugin.analysis</groupId>
    <artifactId>inugami-project-analysis-maven-plugin</artifactId>
    <version>1.4.1</version>
</dependency>
----

== Quick start :

This maven plugin use Neo4J database to store information and resolve them.
If you haven't a Neo4J you can for test or on your local environment run a Neo4J with docker.

.docker-compose.yml
[source,yaml]
----
version: "3"
services:
  neo4j:
    image: neo4j:4.1.1
    ports:
      - "7474:7474"
      - "7473:7473"
      - "7687:7687"
    expose:
      - 7474
      - 7473
      - 7687
    environment:
      - NEO4J_AUTH=neo4j/password
      - EXTENSION_SCRIPT=/var/lib/neo4j/import/neo4j-bootstrap.sh
      - NEO4J_dbms_unmanaged__extension__classes=semantics.extension=/rdf
      - NEO4J_dbms_security_procedures_whitelist=apoc.coll.*,apoc.load.*,semantics.*
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,semantics.*
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
    volumes:
      - ./import:/var/lib/neo4j/import
      - ./conf:/var/lib/neo4j/conf
      - ./logs:/var/lib/neo4j/logs
      - ./plugins:/var/lib/neo4j/plugins
    networks:
      - neo4j-network
networks:
  neo4j-network:
    driver: bridge
----




In your project pom.xml (or settings) we need to add some properties :

[source,xml]
----
<properties>
    <inugami.maven.plugin.analysis.project.base.name>your.base.package</inugami.maven.plugin.analysis.project.base.name>
    <inugami.maven.plugin.analysis.writer.neo4j.url>bolt://localhost:7687</inugami.maven.plugin.analysis.writer.neo4j.url>
    <inugami.maven.plugin.analysis.writer.neo4j.user>neo4j</inugami.maven.plugin.analysis.writer.neo4j.user>
    <inugami.maven.plugin.analysis.writer.neo4j.password>password</inugami.maven.plugin.analysis.writer.neo4j.password>
</properties>
----

In your project build definition :
[source,xml]
----
<plugin>
    <groupId>io.inugami.maven.plugin.analysis</groupId>
    <artifactId>inugami-project-analysis-maven-plugin</artifactId>
    <version>1.4.1</version>
    <extensions>true</extensions>
    <executions>
        <execution>
            <id>check</id>
            <phase>analyze</phase>
            <goals>
                <goal>check</goal>
            </goals>
        </execution>
        <execution>
            <id>info</id>
            <phase>info</phase>
            <goals>
                <goal>retrieveInformation</goal>
            </goals>
        </execution>
    </executions>
</plugin>
----

First you need to analyse your project to send into Neo4j data :

[source,bash]
----
mvn analyze
----

image::doc/analyze-01.png[]
image::doc/analyze-02.png[]

After this analyse you can see in Neo4j your project information or execute maven phase  info

[source,bash]
----
mvn info
----
image::doc/info.png[]

This phase require to specify an action to display information

== Neo4j data structure :
image::doc/nodes.png[]


== Retrieve information :

=== restServices

[source,bash]
----
mvn info -Daction=restServices
----
image::doc/restServices-01.png[]

=== queryDisplay
Query display allow to generate a Neo4J cypher query from current projet.

[source,bash]
----
mvn info -Daction=queryDisplay
----
image::doc/queryDisplay-01.png[]

Different queries are available, so it's require to specify which one you want to use.

----
mvn info -Daction=queryDisplay -Dquery=search_services_rest
----
image::doc/queryDisplay-02.png[]

[source,bash]
----
mvn info -Daction=queryDisplay -Dquery=search_error_codes

[INFO] selected query :
Match (version:Version) where version.groupId= "io.inugami.demo" and version.artifactId="project-consumer" and version.version="0.0.1-SNAPSHOT"
OPTIONAL MATCH (version)-[:PROJECT_DEPENDENCY*0..10]->(dependency:Version)-[:HAS_ERROR_CODE]->(error:ErrorCode)
return dependency,
       error
----



=== properties

[source,bash]
----
mvn info -Daction=properties
----

=== queueInfo

[source,bash]
----
mvn info -Daction=queueInfo
----

=== errorDisplay

[source,bash]
----
mvn info -Daction=errorDisplay
----

=== specificsQuery

[source,bash]
----
mvn info -Daction=specificsQuery -Dexport=true
----


.Additional configuration
|===
|Property | type | default value | description

|-Dexport
|boolean
|false
|Allow to export result as CSV file

|===

=== importData

[source,bash]
----
mvn info -Daction=importData
----

=== Deployment management
==== publish

[source,bash]
----
mvn info -Daction=publish
----

.Additional configuration
|===
|Property | type | default value | description

|-Denv
|String
| null
|Destination environment

|-DenvLevel
|int
| 0
|For sort environment it's necessary to add a weight on this one

|-DenvType
|String
| null
|The environment type (like DEV, INT, PREP, PROD..)


|-DautoUnpublish
|boolean
|false
|Allow remove relationship between artifact and environment node


|-DautoUnpublish
|boolean
|false
|Allow remove relationship between artifact and environment node

|-DjustThisVersion
|boolean
|false
|If you want to clean all versions relationship between artifact and environment node

|-DpreviousEnv
|boolean
|false
|For cleaning previous staging environment
|===


==== unpublish

[source,bash]
----
mvn info -Daction=unpublish
----

.Additional configuration
|===
|Property | type | default value | description

|-Dexport
|boolean
|false
|Allow to export result as CSV file

|-DuseMavenProject
|boolean
|false
|Allow to use current project GAV and not ask for this information
|===


==== versionEnv

[source,bash]
----
mvn info -Daction=versionEnv
----


.Additional configuration
|===
|Property | type | default value | description

|-Dexport
|boolean
|false
|Allow to export result as CSV file

|-DuseMavenProject
|boolean
|false
|Allow to use current project GAV and not ask for this information
|===


==== envInfo

[source,bash]
----
mvn info -Daction=envInfo
----

.Additional configuration
|===
|Property | type | default value | description

|-Dexport
|boolean
|false
|Allow to export result as CSV file
|===

=== encodePassword

[source,bash]
----
mvn info -Daction=encodePassword
----


== Analyzers :

=== Feign clients
Feign clients analyzer scan all feign client interface to resolve project consuming REST endpoints;

.Properties
|===
|Property | type | default value | description

|inugami.maven.plugin.analysis.analyzer.feign.enable
|boolean
|true
|Allow to disable feign client analyzer
|===

=== SpringBoot RestControllers
To resolve project REST endpoint exposition, this analyzer scan all SpringBoot RestController.

.Properties
|===
|Property | type | default value | description

|inugami.maven.plugin.analysis.analyzer.restControllers.enable
|boolean
|true
|Allow to disable feign client analyzer
|===

=== Spring properties
Most part of issues on project come from wrong properties configuration.
This analyzer scan all properties injected by @Value annotation or Bean configuration definition.

.Properties
|===
|Property | type | default value | description

|inugami.maven.plugin.analysis.analyzer.properties.enable
|boolean
|true
|Allow to disable feign client analyzer
|===

=== ActiveMQ
For resolve activeMQ consumers and listeners, this analyzer is able to scan all Spring @JmsListener annotation.

.Properties
|===
|Property | type | default value | description

|inugami.maven.plugin.analysis.analyzer.jms.enable
|boolean
|true
|Allow to disable feign client analyzer
|===


=== Error code
For resolve activeMQ consumers and listeners, this analyzer is able to scan all Spring @JmsListener annotation.

.Properties
|===
|Property | type | default value | description

|inugami.maven.plugin.analysis.analyzer.errorCode.enable
|boolean
|true
|Allow to disable error codeanalyzer

|inugami.maven.plugin.analysis.analyzer.errorCode.interface
|String
|io.inugami.api.exceptions.ErrorCode
|Allow to specify the error code interface, configured by default with inugami error code interface

|inugami.maven.plugin.analysis.analyzer.errorCode.fieldName
|String
|errorCode
|Allow to override the default error code "field". This field is resolve with method define in error code interface. Accessor prefix is ignore
|===


==== Sender tracking
Spring doesn't include annotation for ActiveMQ senders. Sending message is execute by calling JmsTemplate.
To retrieve this information, Inugami project have specific annotation to flag your methods who send JMS events :


[source,java]
----
@JmsSender(destination = "${my.activeMq.onUserCreated.queue}", id = "create.user.queue")
public void sendCreateUser(final String someParameter, @JmsSenderBody final User user) {
    // implementation
}
----

The destination have the same sens than Spring @JmsListener destination.

This specific annotation is present in inugami-project-analysis-maven-plugin-annotations :
[source,xml]
----
<dependency>
    <groupId>io.inugami.maven.plugin.analysis</groupId>
    <artifactId>inugami-project-analysis-maven-plugin-annotations</artifactId>
    <version>${io.inugami.maven.plugin.analysis.version}</version>
</dependency>
----




